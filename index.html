<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Ponto e RH</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        /* Estilos Impressão A4 */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            #sidebar, #mobile-menu-btn, .no-print, #login-screen { display: none !important; }
            #main-container { margin-left: 0 !important; width: 100% !important; padding: 0 !important; }
            #app-content { padding: 0 !important; }
            .print-only { display: block !important; }
            .screen-only { display: none !important; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid black; padding: 4px; }
        }
        
        .print-only { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen flex overflow-hidden">

    <!-- LOGIN SCREEN (Admin) -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 hidden flex flex-col justify-center items-center text-white">
        <div class="bg-white text-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <i class="fa-solid fa-lock text-4xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold">Acesso Gestor</h2>
                <p class="text-sm text-gray-500">Sistema de RH & Ponto</p>
            </div>
            <form id="form-login" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Usuário</label>
                    <input type="text" id="login-user" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium">Senha</label>
                    <input type="password" id="login-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="******">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold">ENTRAR</button>
            </form>
            <p id="login-msg" class="mt-4 text-center text-sm text-red-500 hidden"></p>
        </div>
        <p class="mt-4 text-gray-500 text-xs">Acesso restrito a pessoal autorizado.</p>
    </div>

    <!-- SIDEBAR (Admin Only) -->
    <aside id="sidebar" class="bg-slate-800 text-white w-64 flex-shrink-0 hidden flex-col transition-all duration-300 shadow-xl z-20">
        <div class="p-4 border-b border-slate-700 flex items-center gap-3">
            <i class="fa-solid fa-user-tie text-2xl text-blue-400"></i>
            <div>
                <h1 class="font-bold text-lg leading-tight">Gestão RH</h1>
                <p class="text-xs text-slate-400" id="current-manager-name">Admin</p>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="router('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-chart-line w-5"></i> Dashboard
            </button>
            <button onclick="router('rh')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-users w-5"></i> Colaboradores
            </button>
            <button onclick="router('relatorios')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-file-pdf w-5"></i> Relatórios
            </button>
            <button onclick="router('config')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-cogs w-5"></i> Config & Gestores
            </button>
            <button onclick="router('link-ponto')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3 text-blue-300">
                <i class="fa-solid fa-link w-5"></i> Link do Ponto
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <button onclick="logout()" class="w-full text-left px-4 py-2 rounded text-red-400 hover:bg-slate-700 flex items-center gap-2">
                <i class="fa-solid fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <!-- CONTEÚDO PRINCIPAL -->
    <main id="main-container" class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        <!-- Header Mobile (Admin Only) -->
        <header id="mobile-header" class="hidden md:hidden bg-slate-800 text-white p-4 justify-between items-center z-10 shadow">
            <h1 class="font-bold">RH System</h1>
            <button id="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        </header>

        <!-- Área Dinâmica -->
        <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gray-100">
            <div class="flex justify-center items-center h-full">
                <div class="text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-500">Carregando sistema...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center backdrop-blur-sm p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all scale-100"></div>
    </div>

    <!-- JAVASCRIPT APP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLxhi9yn506R-kjlOoMz7R_i7C7c5iRjs",
            authDomain: "apprh-db10f.firebaseapp.com",
            projectId: "apprh-db10f",
            storageBucket: "apprh-db10f.firebasestorage.app",
            messagingSenderId: "1086403355974",
            appId: "1:1086403355974:web:9b31c7cc2f5d4411a27147",
            measurementId: "G-2L7PFCGDRM"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rh-system-v2';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado Global
        let companyConfig = {};
        let employees = [];
        let managers = [];
        let currentManager = null;
        let isKioskMode = false;

        // Path Helper
        const getColl = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        // --- INICIALIZAÇÃO ---
        async function initApp() {
            // Verificar Modo (Admin vs Ponto)
            const urlParams = new URLSearchParams(window.location.search);
            isKioskMode = urlParams.get('mode') === 'ponto';

            // Auth Anônima para Conexão ao DB
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await loadConfig();
                    if (isKioskMode) {
                        // Modo Kiosk: Renderiza direto o ponto, sem login admin
                        renderPonto(document.getElementById('app-content'));
                    } else {
                        // Modo Admin: Mostra Login
                        checkAdminExists(); // Seed se necessário
                        showLoginScreen();
                    }
                }
            });
        }

        // --- GESTÃO DE ACESSO (Login Admin) ---
        async function checkAdminExists() {
            const snap = await getDocs(getColl('managers'));
            if (snap.empty) {
                // Criar Super Admin Padrão
                await addDoc(getColl('managers'), {
                    user: 'admin',
                    pass: '123456', // Em prod usar hash
                    name: 'Super Admin',
                    role: 'super_admin'
                });
                console.log("Super Admin criado: admin / 123456");
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('flex');
            
            document.getElementById('form-login').onsubmit = async (e) => {
                e.preventDefault();
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                const msg = document.getElementById('login-msg');

                msg.classList.add('hidden');
                
                // Login Simples (Query no Firestore - Demo)
                const q = query(getColl('managers'), where('user', '==', u), where('pass', '==', p));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    currentManager = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    document.getElementById('current-manager-name').innerText = currentManager.name;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('sidebar').classList.add('flex');
                    document.getElementById('mobile-header').classList.remove('hidden');
                    document.getElementById('mobile-header').classList.add('flex');
                    router('dashboard');
                } else {
                    msg.innerText = "Usuário ou senha inválidos.";
                    msg.classList.remove('hidden');
                }
            };
        }

        window.logout = () => {
            currentManager = null;
            window.location.reload();
        };

        async function loadConfig() {
            const snap = await getDocs(getColl('config'));
            if (!snap.empty) companyConfig = { id: snap.docs[0].id, ...snap.docs[0].data() };
            else companyConfig = { nome: "Empresa Demo", cnpj: "", logoUrl: "https://via.placeholder.com/150" };
        }

        // --- ROTEAMENTO ---
        window.router = async (view) => {
            const container = document.getElementById('app-content');
            container.innerHTML = '<div class="flex justify-center mt-10"><div class="loader"></div></div>';
            
            // Highlight nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-slate-700', 'border-l-4', 'border-blue-400'));
            
            // Close mobile menu
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');

            switch(view) {
                case 'dashboard': await renderDashboard(container); break;
                case 'rh': await renderRH(container); break;
                case 'relatorios': await renderRelatorios(container); break;
                case 'config': await renderConfig(container); break;
                case 'link-ponto': renderLinkPonto(container); break;
            }
        };

        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('absolute');
            sb.classList.toggle('h-full');
            sb.classList.toggle('z-50');
        };

        // --- MÓDULO PONTO (KIOSK - ISOLADO) ---
        async function renderPonto(container) {
            // Remove margens e paddings do main container para ficar full screen
            document.getElementById('main-container').className = "w-full h-full bg-slate-900 flex items-center justify-center p-4";
            
            const snap = await getDocs(getColl('employees'));
            employees = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.nomeCompleto.localeCompare(b.nomeCompleto));

            container.innerHTML = `
                <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="bg-blue-800 p-6 text-white text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-full bg-blue-600 opacity-20 transform -skew-y-6 origin-top-left"></div>
                        <img src="${companyConfig.logoUrl}" class="h-16 mx-auto mb-3 bg-white p-2 rounded shadow relative z-10" onerror="this.style.display='none'">
                        <h2 class="text-2xl font-bold relative z-10">${companyConfig.nome}</h2>
                        <p class="opacity-80 relative z-10 text-sm">Registro de Ponto Eletrônico</p>
                    </div>
                    
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <div id="relogio" class="text-4xl font-mono text-slate-700 font-bold tracking-widest">--:--:--</div>
                            <div id="data" class="text-gray-500 uppercase text-xs font-bold mt-1">--</div>
                        </div>

                        <label class="block text-sm font-bold text-gray-700 mb-2">Colaborador</label>
                        <select id="ponto-user" class="w-full text-lg border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 outline-none transition-colors bg-gray-50 mb-6">
                            <option value="">Selecione seu nome...</option>
                            ${employees.map(e => `<option value="${e.id}">${e.nomeCompleto}</option>`).join('')}
                        </select>

                        <div id="ponto-actions" class="hidden animate-fade-in-up">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-6 text-center text-sm text-blue-800">
                                Status Atual: <span id="last-status" class="font-bold">...</span>
                            </div>
                            
                            <button id="btn-ponto" class="w-full py-4 rounded-xl text-white text-xl font-bold shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-3">
                                <span>REGISTRAR</span>
                            </button>
                            
                            <div class="mt-4 text-center text-xs text-gray-400 flex justify-center gap-4">
                                <span><i class="fa-solid fa-location-dot"></i> GPS Ativo</span>
                                <span><i class="fa-solid fa-camera"></i> Foto Simulada</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setInterval(() => {
                const now = new Date();
                const elR = document.getElementById('relogio');
                if(elR) {
                    elR.innerText = now.toLocaleTimeString('pt-BR');
                    document.getElementById('data').innerText = now.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
                }
            }, 1000);

            const select = document.getElementById('ponto-user');
            select.addEventListener('change', async (e) => {
                const uid = e.target.value;
                const area = document.getElementById('ponto-actions');
                
                if(!uid) { area.classList.add('hidden'); return; }
                
                // Buscar status
                const q = query(getColl('registros_ponto')); 
                const snap = await getDocs(q);
                // Filtro em memória por limitação do Firestore query composto sem index
                const today = new Date(); today.setHours(0,0,0,0);
                const userRecs = snap.docs.map(d=>d.data())
                    .filter(d => d.userId === uid && d.timestamp.toDate() >= today)
                    .sort((a,b) => a.timestamp.toDate() - b.timestamp.toDate());

                const last = userRecs.length ? userRecs[userRecs.length-1].tipo : null;
                
                // Máquina de Estados
                let next = 'Entrada';
                let color = 'bg-green-600 hover:bg-green-500';
                let icon = '<i class="fa-solid fa-sun"></i>';
                
                if(last === 'Entrada') { next = 'Saída Almoço'; color = 'bg-yellow-600 hover:bg-yellow-500'; icon = '<i class="fa-solid fa-utensils"></i>'; }
                else if(last === 'Saída Almoço') { next = 'Volta Almoço'; color = 'bg-orange-600 hover:bg-orange-500'; icon = '<i class="fa-solid fa-briefcase"></i>'; }
                else if(last === 'Volta Almoço') { next = 'Saída'; color = 'bg-red-600 hover:bg-red-500'; icon = '<i class="fa-solid fa-home"></i>'; }
                else if(last === 'Saída') { next = 'Hora Extra'; color = 'bg-purple-600 hover:bg-purple-500'; icon = '<i class="fa-solid fa-plus-circle"></i>'; }

                document.getElementById('last-status').innerText = last || 'Sem registro hoje';
                const btn = document.getElementById('btn-ponto');
                btn.className = `w-full py-4 rounded-xl text-white text-xl font-bold shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-3 ${color}`;
                btn.innerHTML = `${icon} <span>Registrar ${next}</span>`;
                
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.innerHTML = '<div class="loader w-6 h-6 border-white"></div>';
                    await addDoc(getColl('registros_ponto'), {
                        userId: uid,
                        tipo: next,
                        timestamp: serverTimestamp(),
                        geo: "-23.5505,-46.6333", // Mock
                        foto: true
                    });
                    alert('Ponto registrado com sucesso!');
                    select.value = "";
                    select.dispatchEvent(new Event('change'));
                };

                area.classList.remove('hidden');
            });
        }

        // --- GESTÃO DE COLABORADORES (Admin) ---
        async function renderRH(container) {
            const snap = await getDocs(getColl('employees'));
            employees = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderTableRH(container, employees);
        }

        function renderTableRH(container, data) {
            // Filtros e Lista
            const rows = data.map(e => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 font-medium">${e.nomeCompleto}</td>
                    <td class="p-3 text-gray-500">${e.estado || '-'}</td>
                    <td class="p-3 hidden sm:table-cell">${e.cargo}</td>
                    <td class="p-3 text-center">
                        <button onclick="editEmp('${e.id}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delEmp('${e.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Colaboradores</h2>
                        <button onclick="editEmp()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Novo Cadastro
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-gray-50 p-4 rounded">
                        <input id="search-name" placeholder="Buscar por Nome..." class="border p-2 rounded w-full" onkeyup="filterRH()">
                        <select id="search-uf" class="border p-2 rounded w-full" onchange="filterRH()">
                            <option value="">Todos os Estados</option>
                            <option value="SP">SP</option><option value="RJ">RJ</option><option value="MG">MG</option>
                            <option value="RS">RS</option><option value="PR">PR</option><option value="SC">SC</option>
                            <!-- Adicionar outros conforme necessidade -->
                        </select>
                    </div>

                    <div class="overflow-x-auto rounded border">
                        <table class="w-full text-left text-sm" id="table-rh">
                            <thead class="bg-gray-100 uppercase text-xs font-bold text-gray-600">
                                <tr>
                                    <th class="p-3">Nome</th>
                                    <th class="p-3">UF</th>
                                    <th class="p-3 hidden sm:table-cell">Cargo</th>
                                    <th class="p-3 text-center w-24">Ações</th>
                                </tr>
                            </thead>
                            <tbody>${rows || '<tr><td colspan="4" class="p-6 text-center text-gray-500">Nenhum registro encontrado.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.filterRH = () => {
            const name = document.getElementById('search-name').value.toLowerCase();
            const uf = document.getElementById('search-uf').value;
            const filtered = employees.filter(e => 
                e.nomeCompleto.toLowerCase().includes(name) && 
                (uf === "" || e.estado === uf)
            );
            // Re-render apenas o TBODY seria melhor, mas aqui re-renderizo tudo por simplicidade do SPA
            // Hack rápido: Manipular DOM direto na tabela existente
            const tbody = document.querySelector('#table-rh tbody');
            tbody.innerHTML = filtered.map(e => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 font-medium">${e.nomeCompleto}</td>
                    <td class="p-3 text-gray-500">${e.estado || '-'}</td>
                    <td class="p-3 hidden sm:table-cell">${e.cargo}</td>
                    <td class="p-3 text-center">
                        <button onclick="editEmp('${e.id}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delEmp('${e.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.editEmp = (id) => {
            const e = id ? employees.find(x => x.id === id) : {};
            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">${id ? 'Editar' : 'Novo'} Colaborador</h3>
                    <form id="form-emp" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="text-xs font-bold text-gray-500 uppercase">Nome Completo</label>
                                <input required id="e-nome" value="${e.nomeCompleto||''}" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">CPF</label>
                                <input id="e-cpf" value="${e.cpf||''}" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Estado (UF)</label>
                                <select id="e-uf" class="w-full border p-2 rounded">
                                    <option value="">Selecione</option>
                                    <option value="SP" ${e.estado==='SP'?'selected':''}>SP</option>
                                    <option value="RJ" ${e.estado==='RJ'?'selected':''}>RJ</option>
                                    <option value="MG" ${e.estado==='MG'?'selected':''}>MG</option>
                                    <option value="RS" ${e.estado==='RS'?'selected':''}>RS</option>
                                    <!-- Outros... -->
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Cargo</label>
                                <input id="e-cargo" value="${e.cargo||''}" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Jornada Diária (HH:mm)</label>
                                <input type="time" id="e-jornada" value="${e.jornadaHHMM||'08:00'}" class="w-full border p-2 rounded font-mono">
                            </div>
                        </div>
                        
                        <div class="mt-4 bg-blue-50 p-4 rounded">
                            <h4 class="font-bold text-sm text-blue-800 mb-2">Dados de Férias</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs">Data Admissão</label>
                                    <input type="date" id="e-admissao" value="${e.feriasDataAdmissao||''}" class="w-full border p-2 rounded">
                                </div>
                                <div>
                                    <label class="text-xs">Próximo Início</label>
                                    <input type="date" id="e-ferias" value="${e.feriasProximaDataInicio||''}" class="w-full border p-2 rounded">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-4">
                            <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');

            document.getElementById('form-emp').onsubmit = async (evt) => {
                evt.preventDefault();
                const data = {
                    nomeCompleto: document.getElementById('e-nome').value,
                    cpf: document.getElementById('e-cpf').value,
                    estado: document.getElementById('e-uf').value,
                    cargo: document.getElementById('e-cargo').value,
                    jornadaHHMM: document.getElementById('e-jornada').value,
                    feriasDataAdmissao: document.getElementById('e-admissao').value,
                    feriasProximaDataInicio: document.getElementById('e-ferias').value
                };
                
                try {
                    if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'employees', id), data);
                    else await addDoc(getColl('employees'), data);
                    closeModal();
                    router('rh');
                } catch(err) { alert('Erro ao salvar'); console.error(err); }
            };
        };
        
        window.delEmp = async (id) => {
            if(confirm('Tem certeza?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'employees', id));
                router('rh');
            }
        };

        // --- DASHBOARD (Com Filtros) ---
        async function renderDashboard(container) {
            // Recarregar emps
            const snapE = await getDocs(getColl('employees'));
            employees = snapE.docs.map(d => ({id:d.id, ...d.data()}));
            
            container.innerHTML = `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">Dashboard de Alertas</h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="dash-filter-uf" class="border p-2 rounded" onchange="updateDash()">
                            <option value="">Todos UF</option>
                            <option value="SP">SP</option><option value="RJ">RJ</option><option value="MG">MG</option>
                        </select>
                        <input id="dash-filter-name" placeholder="Nome..." class="border p-2 rounded" onkeyup="updateDash()">
                    </div>
                </div>
                <div id="dash-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Cards via JS -->
                </div>
            `;
            updateDash();
        }

        window.updateDash = () => {
            const uf = document.getElementById('dash-filter-uf').value;
            const name = document.getElementById('dash-filter-name').value.toLowerCase();
            const container = document.getElementById('dash-cards');
            
            const filtered = employees.filter(e => 
                (uf === "" || e.estado === uf) && 
                e.nomeCompleto.toLowerCase().includes(name)
            );

            if(filtered.length === 0) {
                container.innerHTML = '<p class="col-span-3 text-center text-gray-500">Nenhum colaborador encontrado.</p>';
                return;
            }

            container.innerHTML = filtered.map(e => {
                // Lógica de Férias
                let feriasMsg = "";
                let feriasClass = "";
                if(e.feriasProximaDataInicio) {
                    const diff = Math.ceil((new Date(e.feriasProximaDataInicio) - new Date()) / (1000*60*60*24));
                    if(diff > 0 && diff <= 60) {
                        feriasMsg = `Férias em ${diff} dias`;
                        feriasClass = "border-yellow-400 bg-yellow-50";
                    }
                }
                
                return `
                    <div class="bg-white p-4 rounded shadow border-l-4 ${feriasClass || 'border-blue-500'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${e.nomeCompleto}</h3>
                                <p class="text-xs text-gray-500">${e.cargo || 'Cargo n/a'} - ${e.estado || 'UF n/a'}</p>
                            </div>
                            ${feriasMsg ? '<i class="fa-solid fa-plane text-yellow-600"></i>' : ''}
                        </div>
                        <div class="mt-4 text-sm">
                            <p>Jornada: <strong>${e.jornadaHHMM || '08:00'}</strong></p>
                            ${feriasMsg ? `<p class="text-yellow-700 font-bold mt-2">${feriasMsg}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        };

        // --- RELATÓRIOS (Impressão + Conversão HH:mm) ---
        async function renderRelatorios(container) {
            const snapE = await getDocs(getColl('employees'));
            employees = snapE.docs.map(d => ({id:d.id, ...d.data()}));

            container.innerHTML = `
                <div class="max-w-4xl mx-auto screen-only">
                    <div class="bg-white p-6 rounded shadow mb-6">
                        <h2 class="text-2xl font-bold mb-4">Emissão de Folha de Ponto</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <!-- Filtros Auxiliares -->
                             <select id="rel-filter-uf" class="border p-2 rounded text-sm bg-gray-50" onchange="updateRelSelect()">
                                <option value="">Filtrar Estado (Todos)</option>
                                <option value="SP">SP</option><option value="RJ">RJ</option>
                             </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm mb-1">Colaborador</label>
                                <select id="rel-colaborador" class="w-full border p-2 rounded border-blue-300">
                                    <!-- Options via JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Mês Referência</label>
                                <input type="month" id="rel-mes" class="w-full border p-2 rounded" value="${new Date().toISOString().slice(0,7)}">
                            </div>
                        </div>
                        <button onclick="gerarRelatorio()" class="mt-4 w-full bg-slate-800 text-white p-3 rounded hover:bg-slate-700 font-bold">
                            <i class="fa-solid fa-file-invoice"></i> GERAR RELATÓRIO
                        </button>
                    </div>
                </div>
                
                <!-- Área de Preview (A4) -->
                <div id="relatorio-preview" class="hidden bg-white shadow-lg p-8 mx-auto max-w-[210mm] min-h-[297mm]">
                    <!-- Header da Folha -->
                    <div class="flex justify-between items-center border-b-2 border-black pb-4 mb-4">
                        <div class="flex items-center gap-4">
                            <img src="${companyConfig.logoUrl}" class="h-16 object-contain" onerror="this.style.display='none'">
                            <div>
                                <h1 class="text-xl font-bold uppercase">${companyConfig.nome}</h1>
                                <p class="text-xs">CNPJ: ${companyConfig.cnpj}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <h2 class="text-lg font-bold">FOLHA DE PONTO</h2>
                            <p class="text-sm" id="rel-periodo-txt"></p>
                        </div>
                    </div>
                    
                    <!-- Dados -->
                    <div class="bg-gray-50 border p-2 text-sm grid grid-cols-2 gap-2 mb-4">
                        <div><span class="font-bold">Nome:</span> <span id="rel-p-nome"></span></div>
                        <div><span class="font-bold">Cargo:</span> <span id="rel-p-cargo"></span></div>
                        <div><span class="font-bold">CPF:</span> <span id="rel-p-cpf"></span></div>
                        <div><span class="font-bold">Carga Horária:</span> <span id="rel-p-jornada"></span></div>
                    </div>

                    <!-- Tabela -->
                    <table class="w-full text-xs text-center border mb-4">
                        <thead class="bg-gray-200">
                            <tr>
                                <th>Dia</th><th>Entrada</th><th>Saída Almoço</th><th>Volta Almoço</th><th>Saída</th>
                                <th>Total</th><th>Saldo</th><th>Obs</th>
                            </tr>
                        </thead>
                        <tbody id="rel-tbody"></tbody>
                    </table>

                    <!-- Totais -->
                    <div class="flex justify-end mb-8">
                        <div class="border p-2 w-64 text-sm">
                            <div class="flex justify-between"><span>Previsto:</span> <span id="t-prev"></span></div>
                            <div class="flex justify-between"><span>Realizado:</span> <span id="t-real"></span></div>
                            <div class="flex justify-between font-bold border-t mt-1 pt-1"><span>Saldo:</span> <span id="t-saldo"></span></div>
                        </div>
                    </div>

                    <!-- Assinaturas -->
                    <div class="flex justify-between mt-20 text-xs text-center">
                        <div class="w-1/3 border-t border-black pt-2">Assinatura Colaborador</div>
                        <div class="w-1/3 border-t border-black pt-2">Assinatura Gestor</div>
                    </div>

                    <div class="screen-only fixed bottom-8 right-8">
                        <button onclick="window.print()" class="bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700"><i class="fa-solid fa-print text-xl"></i></button>
                    </div>
                </div>
            `;
            updateRelSelect();
        }

        window.updateRelSelect = () => {
            const uf = document.getElementById('rel-filter-uf')?.value || "";
            const sel = document.getElementById('rel-colaborador');
            if(!sel) return;
            
            const filtered = employees.filter(e => uf === "" || e.estado === uf);
            sel.innerHTML = filtered.map(e => `<option value="${e.id}">${e.nomeCompleto}</option>`).join('');
        };

        window.gerarRelatorio = async () => {
            const uid = document.getElementById('rel-colaborador').value;
            const mesAno = document.getElementById('rel-mes').value;
            
            if(!uid) return alert('Selecione um colaborador');
            
            const emp = employees.find(e => e.id === uid);
            const [year, month] = mesAno.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Buscar Pontos
            const q = query(getColl('registros_ponto'), where('userId', '==', uid));
            const snap = await getDocs(q);
            
            // Filtrar e Organizar
            const points = snap.docs.map(d => ({...d.data(), date: d.data().timestamp.toDate()}))
                .filter(p => p.date.getMonth() === month-1 && p.date.getFullYear() === year)
                .sort((a,b) => a.date - b.date);

            // Converter Jornada HH:mm para minutos
            const [h, m] = (emp.jornadaHHMM || "08:00").split(':').map(Number);
            const dailyMinutesExpected = (h*60) + m;

            let tbodyHtml = '';
            let totalWorked = 0;
            let totalExpected = 0;

            for(let i=1; i<=daysInMonth; i++) {
                const dia = new Date(year, month-1, i);
                const isWeekend = dia.getDay() === 0 || dia.getDay() === 6;
                const diaRecs = points.filter(p => p.date.getDate() === i);

                // Helper Horário
                const getH = (tipo) => {
                    const r = diaRecs.find(x => x.tipo.includes(tipo));
                    return r ? r.date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '';
                }

                const e1 = getH('Entrada');
                const s1 = getH('Saída Almoço');
                const e2 = getH('Volta Almoço');
                const s2 = getH('Saída');

                // Cálculo Simplificado (Considera pares E1-S1 e E2-S2 ou E1-S2 direto se faltar almoço)
                let minutes = 0;
                if(diaRecs.length >= 2) {
                    const first = diaRecs[0].date;
                    const last = diaRecs[diaRecs.length-1].date;
                    minutes = Math.floor((last - first) / 60000);
                    // Se teve almoço, subtrai
                    const pS1 = diaRecs.find(x => x.tipo.includes('Saída Almoço'));
                    const pE2 = diaRecs.find(x => x.tipo.includes('Volta Almoço'));
                    if(pS1 && pE2) {
                        minutes -= Math.floor((pE2.date - pS1.date) / 60000);
                    }
                }

                const exp = isWeekend ? 0 : dailyMinutesExpected;
                totalWorked += minutes;
                totalExpected += exp;
                const bal = minutes - exp;

                const fmt = (min) => {
                    const abs = Math.abs(min);
                    return `${Math.floor(abs/60).toString().padStart(2,'0')}:${(abs%60).toString().padStart(2,'0')}`;
                }

                tbodyHtml += `
                    <tr class="${isWeekend ? 'bg-gray-100 text-gray-400' : ''}">
                        <td>${i.toString().padStart(2,'0')}</td>
                        <td>${e1}</td><td>${s1}</td><td>${e2}</td><td>${s2}</td>
                        <td>${fmt(minutes)}</td>
                        <td class="${bal < 0 ? 'text-red-600' : 'text-blue-600'} font-bold">${bal<0?'-':'+'}${fmt(bal)}</td>
                        <td>${isWeekend ? 'DSR' : ''}</td>
                    </tr>
                `;
            }

            // Render Preview
            document.getElementById('rel-periodo-txt').innerText = `${month}/${year}`;
            document.getElementById('rel-p-nome').innerText = emp.nomeCompleto;
            document.getElementById('rel-p-cargo').innerText = emp.cargo;
            document.getElementById('rel-p-cpf').innerText = emp.cpf;
            document.getElementById('rel-p-jornada').innerText = emp.jornadaHHMM;
            document.getElementById('rel-tbody').innerHTML = tbodyHtml;
            
            const fmtT = (m) => `${Math.floor(Math.abs(m)/60)}:${(Math.abs(m)%60).toString().padStart(2,'0')}`;
            document.getElementById('t-prev').innerText = fmtT(totalExpected);
            document.getElementById('t-real').innerText = fmtT(totalWorked);
            const finalBal = totalWorked - totalExpected;
            document.getElementById('t-saldo').innerText = (finalBal>=0?'+':'-') + fmtT(finalBal);
            document.getElementById('t-saldo').className = finalBal >= 0 ? 'text-blue-600 font-bold' : 'text-red-600 font-bold';

            document.getElementById('relatorio-preview').classList.remove('hidden');
        };

        // --- CONFIGURAÇÕES & GESTORES ---
        async function renderConfig(container) {
            // Get managers
            const snapM = await getDocs(getColl('managers'));
            managers = snapM.docs.map(d => ({id:d.id, ...d.data()}));

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Config Empresa -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">Dados da Empresa</h3>
                        <div class="space-y-3">
                            <input id="cfg-nome" value="${companyConfig.nome||''}" placeholder="Nome Empresa" class="w-full border p-2 rounded">
                            <input id="cfg-cnpj" value="${companyConfig.cnpj||''}" placeholder="CNPJ" class="w-full border p-2 rounded">
                            <input id="cfg-logo" value="${companyConfig.logoUrl||''}" placeholder="URL Logo" class="w-full border p-2 rounded">
                            <button onclick="saveCfg()" class="bg-blue-600 text-white w-full py-2 rounded">Salvar Empresa</button>
                        </div>
                    </div>

                    <!-- Gestores -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">Gestores Cadastrados</h3>
                        <ul class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${managers.map(m => `
                                <li class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">
                                    <span><strong>${m.user}</strong> (${m.name})</span>
                                    ${m.role === 'super_admin' ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Super Admin</span>' : 
                                    `<button onclick="delManager('${m.id}')" class="text-red-600"><i class="fa-solid fa-trash"></i></button>`}
                                </li>
                            `).join('')}
                        </ul>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-bold mb-2">Novo Gestor</h4>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input id="new-m-user" placeholder="Usuário" class="border p-2 rounded text-sm">
                                <input id="new-m-pass" placeholder="Senha" class="border p-2 rounded text-sm">
                            </div>
                            <input id="new-m-name" placeholder="Nome Completo" class="w-full border p-2 rounded text-sm mb-2">
                            <button onclick="addManager()" class="bg-green-600 text-white w-full py-2 rounded text-sm">Adicionar Gestor</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.saveCfg = async () => {
            const data = {
                nome: document.getElementById('cfg-nome').value,
                cnpj: document.getElementById('cfg-cnpj').value,
                logoUrl: document.getElementById('cfg-logo').value
            };
            if(companyConfig.id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', companyConfig.id), data);
            else await addDoc(getColl('config'), data);
            alert('Salvo!'); loadConfig();
        };

        window.addManager = async () => {
            const u = document.getElementById('new-m-user').value;
            const p = document.getElementById('new-m-pass').value;
            const n = document.getElementById('new-m-name').value;
            if(!u || !p) return alert('Preencha usuario e senha');
            
            await addDoc(getColl('managers'), { user: u, pass: p, name: n, role: 'manager' });
            renderConfig(document.getElementById('app-content'));
        };

        window.delManager = async (id) => {
            if(confirm('Remover acesso deste gestor?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'managers', id));
                renderConfig(document.getElementById('app-content'));
            }
        };

        // --- LINK DE EMBED ---
        window.renderLinkPonto = (container) => {
            const url = window.location.href.split('?')[0] + '?mode=ponto';
            const iframeCode = `<iframe src="${url}" style="width:100%; height:100%; border:none; min-height: 600px;"></iframe>`;
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded shadow max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-blue-800"><i class="fa-solid fa-link"></i> Link do Ponto (Modo Quiosque)</h2>
                    <p class="text-gray-600 mb-4">Use este link em tablets ou computadores dedicados para que os funcionários batam ponto sem acesso administrativo.</p>
                    
                    <div class="mb-4">
                        <label class="font-bold text-sm">Link Direto:</label>
                        <div class="flex gap-2">
                            <input value="${url}" readonly class="w-full border p-2 bg-gray-100 rounded text-sm font-mono">
                            <button onclick="navigator.clipboard.writeText('${url}')" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Copiar</button>
                        </div>
                    </div>

                    <div>
                        <label class="font-bold text-sm">Código Iframe (Para Embed):</label>
                        <div class="flex gap-2">
                            <textarea readonly class="w-full border p-2 bg-gray-100 rounded text-sm font-mono h-24">${iframeCode}</textarea>
                            <button onclick="navigator.clipboard.writeText(\`${iframeCode}\`)" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 h-24">Copiar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        document.getElementById('modal-overlay').addEventListener('click', (e) => { if(e.target.id === 'modal-overlay') window.closeModal() });

        initApp();
    </script>
</body>
</html>
