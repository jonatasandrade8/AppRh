<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Ponto e RH</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        /* Estilos específicos para Impressão A4 */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            #sidebar, #mobile-menu-btn, .no-print { display: none !important; }
            #main-container { margin-left: 0 !important; width: 100% !important; padding: 0 !important; }
            #app-content { padding: 0 !important; }
            .print-only { display: block !important; }
            .screen-only { display: none !important; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid black; padding: 4px; }
        }
        
        .print-only { display: none; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar Navegação -->
    <aside id="sidebar" class="bg-slate-800 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300">
        <div class="p-4 border-b border-slate-700 flex items-center gap-3">
            <i class="fa-solid fa-clock text-2xl text-blue-400"></i>
            <h1 class="font-bold text-lg">RH System</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="router('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-chart-line w-5"></i> Dashboard/Alertas
            </button>
            <button onclick="router('ponto')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-fingerprint w-5"></i> Bater Ponto
            </button>
            <button onclick="router('rh')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-users w-5"></i> Gestão RH
            </button>
            <button onclick="router('relatorios')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-file-pdf w-5"></i> Relatórios
            </button>
            <button onclick="router('config')" class="nav-item w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition flex items-center gap-3">
                <i class="fa-solid fa-cog w-5"></i> Configurações
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700 text-xs text-slate-400">
            v1.0.0 - Single File App
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main id="main-container" class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        <!-- Header Mobile -->
        <header class="md:hidden bg-slate-800 text-white p-4 flex justify-between items-center z-10">
            <h1 class="font-bold">RH System</h1>
            <button id="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        </header>

        <!-- Área de Conteúdo Dinâmico -->
        <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            <!-- O conteúdo será injetado aqui pelo JavaScript -->
            <div class="flex justify-center items-center h-full">
                <div class="text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-500">Inicializando sistema...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Universal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center backdrop-blur-sm p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all scale-100">
            <!-- Conteúdo do modal -->
        </div>
    </div>

    <!-- Scripts da Aplicação -->
    <script type="module">
        // --- 1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis de ambiente injetadas ou padrão
        const firebaseConfig = {apiKey: "AIzaSyBLxhi9yn506R-kjlOoMz7R_i7C7c5iRjs",
                                authDomain: "apprh-db10f.firebaseapp.com",
                                projectId: "apprh-db10f",
                                storageBucket: "apprh-db10f.firebasestorage.app",
                                messagingSenderId: "1086403355974",
                                appId: "1:1086403355974:web:9b31c7cc2f5d4411a27147",
                                measurementId: "G-2L7PFCGDRM"
                                };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-rh-system';
        
        // Inicialização
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado Global
        let currentUser = null;
        let companyConfig = {};
        let employees = [];
        let currentView = 'dashboard';

        // --- 2. AUTH E INICIALIZAÇÃO ---
        
        async function initApp() {
            try {
                // Auth
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadCompanyConfig();
                        await loadEmployees();
                        router('dashboard'); // Inicia no Dashboard
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização:", error);
                document.getElementById('app-content').innerHTML = `<div class="text-red-500 text-center mt-10">Erro ao conectar ao banco de dados.<br>${error.message}</div>`;
            }
        }

        // --- 3. FUNÇÕES DE BANCO DE DADOS (Helpers) ---

        // Caminho Seguro (Rule 1 Compliance)
        const getColl = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);

        async function loadCompanyConfig() {
            const querySnapshot = await getDocs(getColl('config'));
            if (!querySnapshot.empty) {
                companyConfig = querySnapshot.docs[0].data();
                companyConfig.id = querySnapshot.docs[0].id; // Salva o ID para update
            } else {
                // Configuração Padrão
                companyConfig = {
                    nome: "Minha Empresa LTDA",
                    cnpj: "00.000.000/0001-91",
                    endereco: "Rua Exemplo, 123, Centro",
                    logoUrl: "https://via.placeholder.com/150?text=LOGO"
                };
            }
        }

        async function loadEmployees() {
            const q = query(getColl('employees')); // No complex sorting here per Rule 2, sort in JS
            const querySnapshot = await getDocs(q);
            employees = [];
            querySnapshot.forEach((doc) => {
                employees.push({ id: doc.id, ...doc.data() });
            });
            // Ordenação local
            employees.sort((a, b) => a.nomeCompleto.localeCompare(b.nomeCompleto));
        }

        // --- 4. ROTEAMENTO E RENDERIZAÇÃO ---

        window.router = async (viewName) => {
            currentView = viewName;
            const contentDiv = document.getElementById('app-content');
            
            // Highlight Menu
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-slate-700', 'border-l-4', 'border-blue-400'));
            // Adiciona highlight (simplificado para demo)
            
            contentDiv.innerHTML = '<div class="flex justify-center mt-10"><div class="loader"></div></div>';

            switch (viewName) {
                case 'config': renderConfig(contentDiv); break;
                case 'rh': await renderRH(contentDiv); break;
                case 'ponto': await renderPonto(contentDiv); break;
                case 'dashboard': await renderDashboard(contentDiv); break;
                case 'relatorios': await renderRelatorios(contentDiv); break;
            }
            
            // Fecha menu mobile se aberto
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
        };

        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('absolute');
            sb.classList.toggle('z-50');
            sb.classList.toggle('h-full');
        };

        // --- 5. MÓDULOS ---

        // === MÓDULO CONFIGURAÇÃO ===
        function renderConfig(container) {
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800 border-b pb-2">Configurações da Empresa</h2>
                    <form id="form-config" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                                <input type="text" id="conf-nome" value="${companyConfig.nome || ''}" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">CNPJ</label>
                                <input type="text" id="conf-cnpj" value="${companyConfig.cnpj || ''}" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Endereço Completo</label>
                                <input type="text" id="conf-endereco" value="${companyConfig.endereco || ''}" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">URL da Logomarca</label>
                                <input type="text" id="conf-logo" value="${companyConfig.logoUrl || ''}" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Insira uma URL de imagem pública.</p>
                                <img src="${companyConfig.logoUrl || ''}" class="h-16 mt-2 object-contain border p-1" onerror="this.style.display='none'">
                            </div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('form-config').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newData = {
                    nome: document.getElementById('conf-nome').value,
                    cnpj: document.getElementById('conf-cnpj').value,
                    endereco: document.getElementById('conf-endereco').value,
                    logoUrl: document.getElementById('conf-logo').value
                };
                
                try {
                    if (companyConfig.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', companyConfig.id), newData);
                    } else {
                        await addDoc(getColl('config'), newData);
                    }
                    companyConfig = { ...newData, id: companyConfig.id };
                    alert('Configurações salvas!');
                    router('config');
                } catch (err) {
                    console.error(err);
                    alert('Erro ao salvar.');
                }
            });
        }

        // === MÓDULO RH (COLABORADORES) ===
        async function renderRH(container) {
            await loadEmployees(); // Refresh data
            
            const rows = employees.map(emp => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 border-b">${emp.nomeCompleto}</td>
                    <td class="p-3 border-b hidden sm:table-cell">${emp.cpf}</td>
                    <td class="p-3 border-b hidden md:table-cell">${emp.cargo || 'Não inf.'}</td>
                    <td class="p-3 border-b text-center">
                        <button onclick="openEmployeeModal('${emp.id}')" class="text-blue-600 hover:text-blue-800 mx-1"><i class="fa-solid fa-edit"></i></button>
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-800 mx-1"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="bg-white rounded shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Colaboradores</h2>
                        <button onclick="openEmployeeModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Novo Colaborador
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-100 uppercase font-medium">
                                <tr>
                                    <th class="p-3 border-b">Nome</th>
                                    <th class="p-3 border-b hidden sm:table-cell">CPF</th>
                                    <th class="p-3 border-b hidden md:table-cell">Cargo</th>
                                    <th class="p-3 border-b text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>${rows.length ? rows : '<tr><td colspan="4" class="p-4 text-center">Nenhum colaborador cadastrado.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.openEmployeeModal = (id = null) => {
            const emp = id ? employees.find(e => e.id === id) : {};
            const modal = document.getElementById('modal-content');
            
            modal.innerHTML = `
                <div class="p-6">
                    <h3 class="text-xl font-bold mb-4">${id ? 'Editar' : 'Novo'} Colaborador</h3>
                    <form id="form-employee" class="space-y-3">
                        <input type="hidden" id="emp-id" value="${id || ''}">
                        
                        <!-- Dados Pessoais -->
                        <h4 class="font-semibold text-blue-600 border-b pb-1">Dados Pessoais</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input required placeholder="Nome Completo" class="border p-2 rounded w-full" id="emp-nome" value="${emp.nomeCompleto || ''}">
                            <input placeholder="CPF" class="border p-2 rounded w-full" id="emp-cpf" value="${emp.cpf || ''}">
                            <input placeholder="PIS/NIS" class="border p-2 rounded w-full" id="emp-pis" value="${emp.nisPIS || ''}">
                            <input placeholder="RG" class="border p-2 rounded w-full" id="emp-rg" value="${emp.rg || ''}">
                            <input type="date" placeholder="Data Nascimento" class="border p-2 rounded w-full" id="emp-nasc" value="${emp.dataNascimento || ''}">
                            <input placeholder="Cargo/Função" class="border p-2 rounded w-full" id="emp-cargo" value="${emp.cargo || ''}">
                        </div>
                        <input placeholder="Endereço Completo" class="border p-2 rounded w-full" id="emp-end" value="${emp.endereco || ''}">

                        <!-- Jornada -->
                        <h4 class="font-semibold text-blue-600 border-b pb-1 mt-2">Jornada</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs">Horas/Dia</label>
                                <input type="number" class="border p-2 rounded w-full" id="emp-horas" value="${emp.horasDia || 8}">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs">Horários Padrão (Texto)</label>
                                <input placeholder="Ex: 08:00-12:00, 13:00-17:00" class="border p-2 rounded w-full" id="emp-padrao" value="${emp.horariosPadrao || ''}">
                            </div>
                        </div>

                        <!-- Férias -->
                        <h4 class="font-semibold text-blue-600 border-b pb-1 mt-2">Férias</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs">Data Admissão</label>
                                <input type="date" class="border p-2 rounded w-full" id="emp-admissao" value="${emp.feriasDataAdmissao || ''}">
                            </div>
                            <div>
                                <label class="text-xs">Próximo Início Férias</label>
                                <input type="date" class="border p-2 rounded w-full" id="emp-proxferias" value="${emp.feriasProximaDataInicio || ''}">
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('modal-overlay').classList.remove('hidden');
            
            document.getElementById('form-employee').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    nomeCompleto: document.getElementById('emp-nome').value,
                    cpf: document.getElementById('emp-cpf').value,
                    nisPIS: document.getElementById('emp-pis').value,
                    rg: document.getElementById('emp-rg').value,
                    dataNascimento: document.getElementById('emp-nasc').value,
                    cargo: document.getElementById('emp-cargo').value,
                    endereco: document.getElementById('emp-end').value,
                    horasDia: parseFloat(document.getElementById('emp-horas').value),
                    horariosPadrao: document.getElementById('emp-padrao').value,
                    feriasDataAdmissao: document.getElementById('emp-admissao').value,
                    feriasProximaDataInicio: document.getElementById('emp-proxferias').value,
                };

                const editId = document.getElementById('emp-id').value;
                try {
                    if(editId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'employees', editId), data);
                    } else {
                        await addDoc(getColl('employees'), data);
                    }
                    closeModal();
                    router('rh');
                } catch(err) {
                    console.error(err);
                    alert('Erro ao salvar colaborador.');
                }
            };
        };

        window.deleteEmployee = async (id) => {
            if(confirm('Tem certeza? Isso não apaga os pontos batidos, apenas o cadastro.')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'employees', id));
                router('rh');
            }
        };

        // === MÓDULO PONTO (Simulação Embed) ===
        
        async function renderPonto(container) {
            await loadEmployees();
            
            container.innerHTML = `
                <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
                    <div class="bg-slate-800 p-4 text-white text-center">
                        <img src="${companyConfig.logoUrl || ''}" class="h-10 mx-auto mb-2 object-contain bg-white rounded p-1" onerror="this.style.display='none'">
                        <h2 class="text-xl font-bold">Registro de Ponto</h2>
                        <div id="relogio-digital" class="text-3xl font-mono mt-2 tracking-widest">--:--:--</div>
                        <div id="data-hoje" class="text-sm opacity-80">--/--/----</div>
                    </div>
                    
                    <div class="p-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Identifique-se:</label>
                        <select id="ponto-colaborador" class="w-full border p-3 rounded mb-6 bg-gray-50 text-lg">
                            <option value="">-- Selecione seu nome --</option>
                            ${employees.map(e => `<option value="${e.id}">${e.nomeCompleto}</option>`).join('')}
                        </select>

                        <div id="ponto-actions" class="text-center hidden">
                            <div class="mb-4 text-gray-600 font-medium">
                                Último registro: <span id="last-record-type" class="text-blue-600">Nenhum hoje</span>
                            </div>
                            
                            <button id="btn-bater-ponto" class="w-48 h-48 rounded-full bg-blue-600 hover:bg-blue-500 text-white shadow-2xl transition-all transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center mx-auto border-8 border-blue-100">
                                <i class="fa-solid fa-fingerprint text-5xl mb-2"></i>
                                <span class="text-xl font-bold uppercase" id="btn-label">REGISTRAR</span>
                            </button>

                            <div class="mt-6 text-xs text-gray-400">
                                <i class="fa-solid fa-location-dot"></i> Geolocalização Ativa<br>
                                <i class="fa-solid fa-camera"></i> Captura de Rosto Simulada
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Relógio
            setInterval(() => {
                const now = new Date();
                const elRel = document.getElementById('relogio-digital');
                if(elRel) {
                    elRel.innerText = now.toLocaleTimeString('pt-BR');
                    document.getElementById('data-hoje').innerText = now.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long'});
                }
            }, 1000);

            // Lógica do Fluxo
            const select = document.getElementById('ponto-colaborador');
            select.addEventListener('change', async (e) => {
                const userId = e.target.value;
                const actionsDiv = document.getElementById('ponto-actions');
                
                if(!userId) {
                    actionsDiv.classList.add('hidden');
                    return;
                }
                
                actionsDiv.classList.remove('hidden');
                actionsDiv.classList.add('opacity-50', 'pointer-events-none'); // Loading
                
                // Buscar pontos de hoje para determinar próximo estado
                const today = new Date();
                today.setHours(0,0,0,0);
                
                const q = query(getColl('registros_ponto')); // Filter in memory
                const snap = await getDocs(q);
                
                // Filtrar na memória
                const userPointsToday = snap.docs
                    .map(d => d.data())
                    .filter(d => d.userId === userId && d.timestamp.toDate() >= today)
                    .sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());

                const last = userPointsToday.length > 0 ? userPointsToday[userPointsToday.length - 1].tipo : null;
                
                // Máquina de Estados
                let nextType = 'Início Jornada';
                let btnColor = 'bg-green-600';
                
                if (last === 'Início Jornada') { nextType = 'Início Almoço'; btnColor = 'bg-yellow-600'; }
                else if (last === 'Início Almoço') { nextType = 'Retorno Almoço'; btnColor = 'bg-orange-600'; }
                else if (last === 'Retorno Almoço') { nextType = 'Fim Jornada'; btnColor = 'bg-red-600'; }
                else if (last === 'Fim Jornada') { nextType = 'Hora Extra/Outro'; btnColor = 'bg-purple-600'; }

                const btn = document.getElementById('btn-bater-ponto');
                document.getElementById('btn-label').innerText = nextType;
                document.getElementById('last-record-type').innerText = last || 'Nenhum registro hoje';
                
                // Reset classes and add new color
                btn.className = `w-48 h-48 rounded-full text-white shadow-2xl transition-all transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center mx-auto border-8 border-gray-100 ${btnColor} hover:opacity-90`;

                btn.onclick = () => baterPonto(userId, nextType);

                actionsDiv.classList.remove('opacity-50', 'pointer-events-none');
            });
        }

        async function baterPonto(userId, tipo) {
            // Mock Location
            const mockGeo = "Lat: -23.5505, Long: -46.6333"; 
            
            try {
                await addDoc(getColl('registros_ponto'), {
                    userId,
                    tipo,
                    timestamp: serverTimestamp(),
                    geolocalizacao: mockGeo,
                    fotoCaptura: true
                });
                alert(`Ponto registrado: ${tipo}`);
                // Refresh
                document.getElementById('ponto-colaborador').dispatchEvent(new Event('change'));
            } catch (e) {
                console.error(e);
                alert('Erro ao registrar ponto');
            }
        }

        // === MÓDULO ALERTAS/DASHBOARD ===
        async function renderDashboard(container) {
            await loadEmployees();
            
            // Buscar todos os pontos (Em app real, filtraria por mês)
            const snap = await getDocs(getColl('registros_ponto'));
            const allPoints = snap.docs.map(d => ({...d.data(), dateObj: d.data().timestamp.toDate()}));

            // Lógica Simplificada de Cálculo de Horas (Apenas para demo)
            // Agrupar por Usuario -> Dia
            const reportData = {}; // { userId: { entries: [], ferias: date } }
            
            employees.forEach(emp => {
                reportData[emp.id] = { 
                    name: emp.nomeCompleto, 
                    expected: emp.horasDia || 8,
                    workedHours: 0,
                    vacationWarning: false,
                    daysMissing: 0
                };
                
                // Alerta Férias (30 dias)
                if(emp.feriasProximaDataInicio) {
                    const today = new Date();
                    const vacationDate = new Date(emp.feriasProximaDataInicio + "T00:00:00");
                    const diffTime = vacationDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if(diffDays > 0 && diffDays <= 60) {
                        reportData[emp.id].vacationWarning = `${diffDays} dias`;
                    }
                }
            });

            // Calcular horas simples (Total de Entrada/Saída pares)
            // NOTA: Algoritmo simplificado. Pega 1º e Último do dia para estimativa grosseira no dashboard
            
            const htmlCards = Object.values(reportData).map(d => `
                <div class="bg-white p-4 rounded shadow border-l-4 ${d.vacationWarning ? 'border-yellow-400' : 'border-blue-400'}">
                    <h3 class="font-bold">${d.name}</h3>
                    <div class="text-sm text-gray-600 mt-2">
                        <p>Jornada: ${d.expected}h</p>
                        ${d.vacationWarning ? `<p class="text-yellow-600 font-bold mt-1"><i class="fa-solid fa-plane"></i> Férias em ${d.vacationWarning}</p>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Dashboard & Alertas</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${htmlCards}
                </div>
                <div class="mt-6 bg-blue-50 p-4 rounded text-sm text-blue-800">
                    <i class="fa-solid fa-info-circle"></i> O cálculo detalhado de saldo de horas por dia é realizado no momento da geração do Relatório Mensal para garantir precisão com as batidas de almoço.
                </div>
            `;
        }

        // === MÓDULO RELATÓRIOS (Impressão) ===
        async function renderRelatorios(container) {
            await loadEmployees();
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto screen-only">
                    <div class="bg-white p-6 rounded shadow mb-6">
                        <h2 class="text-2xl font-bold mb-4">Gerar Espelho de Ponto</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="rel-colaborador" class="border p-2 rounded">
                                ${employees.map(e => `<option value="${e.id}">${e.nomeCompleto}</option>`).join('')}
                            </select>
                            <input type="month" id="rel-mes" class="border p-2 rounded" value="${new Date().toISOString().slice(0,7)}">
                            <button onclick="gerarRelatorio()" class="bg-slate-800 text-white p-2 rounded hover:bg-slate-700">
                                <i class="fa-solid fa-file-invoice"></i> Gerar Visualização
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Área do Relatório (Visível na tela e na impressão) -->
                <div id="relatorio-preview" class="hidden bg-white shadow-lg p-8 mx-auto max-w-[210mm] min-h-[297mm]">
                    <!-- Cabeçalho -->
                    <div class="flex justify-between items-start border-b-2 border-black pb-4 mb-4">
                        <div class="flex items-center gap-4">
                            <img src="${companyConfig.logoUrl}" class="h-16 w-16 object-contain" onerror="this.style.display='none'">
                            <div>
                                <h1 class="text-xl font-bold uppercase">${companyConfig.nome || 'EMPRESA'}</h1>
                                <p class="text-xs">CNPJ: ${companyConfig.cnpj || ''}</p>
                                <p class="text-xs">${companyConfig.endereco || ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <h2 class="text-lg font-bold">FOLHA DE PONTO</h2>
                            <p class="text-sm" id="rel-periodo">MÊS/ANO</p>
                        </div>
                    </div>

                    <!-- Dados Colaborador -->
                    <div class="grid grid-cols-2 gap-2 text-sm mb-6 border p-2 bg-gray-50">
                        <div><span class="font-bold">Colaborador:</span> <span id="rel-nome">Nome</span></div>
                        <div><span class="font-bold">Cargo:</span> <span id="rel-cargo">Cargo</span></div>
                        <div><span class="font-bold">CPF:</span> <span id="rel-cpf">000</span></div>
                        <div><span class="font-bold">Jornada:</span> <span id="rel-jornada">08:00 - 18:00</span></div>
                    </div>

                    <!-- Tabela -->
                    <table class="w-full text-xs text-center border-collapse mb-6">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="w-10">Dia</th>
                                <th class="w-16">Entrada</th>
                                <th class="w-16">Almoço</th>
                                <th class="w-16">Volta</th>
                                <th class="w-16">Saída</th>
                                <th class="w-12">Total</th>
                                <th class="w-12">Saldo</th>
                                <th>Ocorrências</th>
                            </tr>
                        </thead>
                        <tbody id="rel-tbody">
                            <!-- Rows generated via JS -->
                        </tbody>
                    </table>

                    <!-- Totais -->
                    <div class="flex justify-end mb-12">
                        <div class="border p-2 w-64 text-sm">
                            <div class="flex justify-between"><span>Horas Previstas:</span> <span class="font-bold" id="total-previstas">00:00</span></div>
                            <div class="flex justify-between"><span>Horas Trabalhadas:</span> <span class="font-bold" id="total-trabalhadas">00:00</span></div>
                            <div class="flex justify-between border-t mt-1 pt-1"><span>Saldo Final:</span> <span class="font-bold text-lg" id="total-saldo">00:00</span></div>
                        </div>
                    </div>

                    <!-- Assinaturas -->
                    <div class="flex justify-between mt-auto pt-10 text-center text-xs">
                        <div class="w-1/3 border-t border-black pt-2">
                            Assinatura do Colaborador
                        </div>
                        <div class="w-1/3 border-t border-black pt-2">
                            ${companyConfig.nome} (RH/Gestor)
                        </div>
                    </div>

                    <!-- Botão Flutuante de Impressão (Tela apenas) -->
                    <div class="fixed bottom-8 right-8 screen-only">
                        <button onclick="window.print()" class="bg-blue-600 text-white rounded-full p-4 shadow-xl hover:bg-blue-700">
                            <i class="fa-solid fa-print fa-lg"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        window.gerarRelatorio = async () => {
            const userId = document.getElementById('rel-colaborador').value;
            const mesAno = document.getElementById('rel-mes').value; // YYYY-MM
            if(!userId || !mesAno) return alert('Selecione colaborador e mês.');

            const [year, month] = mesAno.split('-').map(Number);
            const emp = employees.find(e => e.id === userId);

            // Fetch Points
            const q = query(getColl('registros_ponto')); // Get all, filter later (simpler for this constrained demo)
            const snap = await getDocs(q);
            
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0); // Last day of month

            // Filtrar pontos do mês e usuário
            const points = snap.docs
                .map(d => ({ ...d.data(), date: d.data().timestamp.toDate() }))
                .filter(p => p.userId === userId && p.date >= startDate && p.date <= endDate)
                .sort((a,b) => a.date - b.date);

            // Processar Tabela
            const tbody = document.getElementById('rel-tbody');
            tbody.innerHTML = '';
            
            let totalWorkedMinutes = 0;
            let totalExpectedMinutes = 0;

            const daysInMonth = endDate.getDate();
            
            for(let i = 1; i <= daysInMonth; i++) {
                const currentDay = new Date(year, month - 1, i);
                const dayPoints = points.filter(p => p.date.getDate() === i);
                
                // Formatar horários
                const timeStr = (type) => {
                    const p = dayPoints.find(dp => dp.tipo.includes(type));
                    return p ? p.date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '';
                };
                
                const entrada = timeStr('Início Jornada');
                const almoco = timeStr('Início Almoço');
                const volta = timeStr('Retorno Almoço');
                const saida = timeStr('Fim Jornada');

                // Calcular horas trabalhadas (Lógica simplificada: (Saida - Entrada) - (Volta - Almoco))
                // Para simplificar demo: Assume pares Entrada/Saida se existirem.
                let workedMin = 0;
                
                // Se tiver pelo menos entrada e saída
                if (dayPoints.length >= 2) {
                    const first = dayPoints[0].date;
                    const last = dayPoints[dayPoints.length-1].date;
                    // Desconto básico de 1h se não tiver batida de almoço mas tiver intervalo grande, ou lógica exata
                    const diffMs = last - first;
                    workedMin = Math.floor(diffMs / 60000);
                    
                    // Se tiver almoço registrado, subtrair
                    const pAlm = dayPoints.find(dp => dp.tipo.includes('Início Almoço'));
                    const pVol = dayPoints.find(dp => dp.tipo.includes('Retorno Almoço'));
                    if(pAlm && pVol) {
                        workedMin -= Math.floor((pVol.date - pAlm.date) / 60000);
                    }
                }

                // Fim de semana (Simples: Sab=6, Dom=0)
                const isWeekend = currentDay.getDay() === 0 || currentDay.getDay() === 6;
                const expectedMin = isWeekend ? 0 : (emp.horasDia || 8) * 60;
                
                totalWorkedMinutes += workedMin;
                totalExpectedMinutes += expectedMin;

                const balance = workedMin - expectedMin;
                const balanceStr = (balance > 0 ? '+' : '') + Math.floor(balance/60) + ':' + Math.abs(balance%60).toString().padStart(2,'0');
                
                const rowClass = isWeekend ? 'bg-gray-100 text-gray-400' : '';
                
                const row = `
                    <tr class="${rowClass}">
                        <td>${i}/${month}</td>
                        <td>${entrada}</td>
                        <td>${almoco}</td>
                        <td>${volta}</td>
                        <td>${saida}</td>
                        <td>${Math.floor(workedMin/60)}:${(workedMin%60).toString().padStart(2,'0')}</td>
                        <td class="${balance < 0 ? 'text-red-600' : 'text-blue-600'} font-bold">${isWeekend ? '-' : balanceStr}</td>
                        <td class="text-left px-2 italic text-gray-500">${isWeekend ? 'DSR/Folga' : ''}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }

            // Preencher Totais
            const fmtTotal = (m) => Math.floor(m/60) + ':' + Math.abs(m%60).toString().padStart(2,'0');
            document.getElementById('total-previstas').innerText = fmtTotal(totalExpectedMinutes);
            document.getElementById('total-trabalhadas').innerText = fmtTotal(totalWorkedMinutes);
            const finalBal = totalWorkedMinutes - totalExpectedMinutes;
            document.getElementById('total-saldo').innerText = (finalBal > 0 ? '+' : '-') + fmtTotal(Math.abs(finalBal));
            document.getElementById('total-saldo').className = `text-lg font-bold ${finalBal < 0 ? 'text-red-600' : 'text-blue-600'}`;

            // Preencher Cabeçalho
            document.getElementById('rel-periodo').innerText = `${month.toString().padStart(2,'0')}/${year}`;
            document.getElementById('rel-nome').innerText = emp.nomeCompleto;
            document.getElementById('rel-cargo').innerText = emp.cargo || '-';
            document.getElementById('rel-cpf').innerText = emp.cpf || '-';
            
            // Mostrar Preview
            document.getElementById('relatorio-preview').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
        };
        
        // Helper para fechar modal clicando fora
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') window.closeModal();
        });

        // Iniciar
        initApp();

    </script>
</body>
</html>
